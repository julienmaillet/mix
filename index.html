<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Circle song #1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  background: linear-gradient(135deg,#fff,#eee);
  color: #222;
  font-family: Arial,sans-serif;
  text-align: center;
  margin:0;
  padding:20px;
}
h1 {
  color: #0a3d62;
  text-shadow: 0 0 5px #0a3d62,0 0 10px #74b9ff;
}
#status { margin:15px 0; font-size:1.1em; color:#555; }

#characters {
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:50px;
  flex-wrap:wrap;
}
.character {
  width:60px;
  height:150px;
  position: relative;
  cursor:pointer;
}
.character .head {
  width:40px; height:40px; border-radius:50%;
  background: var(--color); margin:0 auto;
}
.character .body {
  width:15px; height:60px; background:#555; margin:5px auto;
}
.character .arm, .character .leg {
  width:10px; height:40px; background:#555;
  position:absolute; transform-origin:top center;
}
.character .arm.left{left:-15px; top:50px;}
.character .arm.right{right:-15px; top:50px;}
.character .leg.left{left:5px; top:100px;}
.character .leg.right{right:5px; top:100px;}

.character.dancing .body{animation:sway 0.5s infinite alternate;}
.character.dancing .arm{animation:swing 0.5s infinite alternate;}
.character.dancing .leg{animation:step 0.5s infinite alternate;}

@keyframes sway{0%{transform:rotate(-5deg);}100%{transform:rotate(5deg);}}
@keyframes swing{0%{transform:rotate(10deg);}100%{transform:rotate(-10deg);}}
@keyframes step{0%{transform:rotate(-10deg);}100%{transform:rotate(10deg);}}

@media(max-width:500px){
  .character{width:50px;height:120px;}
  .character .head{width:30px;height:30px;}
  .character .body{width:10px;height:50px;}
  .character .arm,.character .leg{width:8px;height:30px;}
}
</style>
</head>
<body>
<h1>Circle song #1</h1>
<div id="status">Chargement des pistes…</div>

<div id="characters">
  <div class="character" data-voice="0" style="--color:#f5a623">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
  <div class="character" data-voice="1" style="--color:#6c5ce7">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
  <div class="character" data-voice="2" style="--color:#00b894">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
  <div class="character" data-voice="3" style="--color:#fd79a8">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
  <div class="character" data-voice="4" style="--color:#e17055">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
  <div class="character" data-voice="5" style="--color:#00cec9">
    <div class="head"></div><div class="body"></div>
    <div class="arm left"></div><div class="arm right"></div>
    <div class="leg left"></div><div class="leg right"></div>
  </div>
</div>

<script>
const trackFiles = ["voix1.wav","voix2.wav","voix3.wav","voix4.wav","voix5.wav","voix6.wav"];
let audioCtx, buffers=[], sources=[], gains=[], analysers=[], isPlaying=false;
const characters = document.querySelectorAll(".character");
const statusEl = document.getElementById("status");
let activeVoices = Array(trackFiles.length).fill(false);

async function loadAll(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  for(let i=0;i<trackFiles.length;i++){
    const resp = await fetch(trackFiles[i]);
    const ab = await resp.arrayBuffer();
    buffers[i] = await audioCtx.decodeAudioData(ab);
  }
  statusEl.textContent = "Clique sur un personnage pour lancer le playback.";
}
loadAll();

function startAll(){
  const startTime = audioCtx.currentTime + 0.05;
  sources=[]; gains=[]; analysers=[];
  buffers.forEach((buf,i)=>{
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.loop = true;
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = 0;
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(gainNode).connect(analyser).connect(audioCtx.destination);
    src.start(startTime);
    sources[i]=src; gains[i]=gainNode; analysers[i]=analyser;
  });
  isPlaying=true;
  statusEl.textContent = "Lecture en cours : clique sur un personnage pour activer/désactiver sa voix.";
  animate();
}

function animate(){
  analysers.forEach((analyser,i)=>{
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    const avg = data.reduce((a,b)=>a+b,0)/data.length;
    if(activeVoices[i] && avg>10){
      characters[i].classList.add("dancing");
    } else {
      characters[i].classList.remove("dancing");
    }
  });
  requestAnimationFrame(animate);
}

characters.forEach((char,i)=>{
  char.addEventListener("click", async ()=>{
    if(!isPlaying){
      if(audioCtx.state==="suspended") await audioCtx.resume();
      startAll();
    }
    activeVoices[i] = !activeVoices[i];
    gains[i].gain.setValueAtTime(activeVoices[i]?1:0,audioCtx.currentTime);
  });
});
</script>
</body>
</html>
